# 用户表结构更新说明

## 更新内容

根据你提供的实际数据库表结构，我已经更新了所有相关的代码文件以匹配新的 `users` 表结构。

## 新的 users 表结构

```sql
CREATE TABLE IF NOT EXISTS `users` (
  `id` varchar(36) NOT NULL COMMENT '用户唯一标识（UUID）',
  `wallet_address` varchar(42) NOT NULL COMMENT '用户链上钱包地址（含0x）',
  `username` varchar(50) NULL COMMENT '用户自定义昵称（唯一）',
  `avatar` varchar(255) NULL COMMENT '用户头像URL（存储图片链接）',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  CONSTRAINT `uk_users_wallet_address` UNIQUE (`wallet_address`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='核心用户身份表';
```

## 主要变更

### 1. User 实体类更新
- `id` 字段类型从 `Long` 改为 `String`（UUID）
- 移除了 `userId`、`email`、`deleted` 字段
- 添加了 `avatar` 字段
- 移除了逻辑删除相关字段

### 2. UserMapper 接口更新
- `selectByUserId` 改为 `selectById`
- 添加了 `selectByUsername` 方法
- `update` 改为 `updateById`
- `deleteByUserId` 改为 `deleteById`（物理删除）

### 3. UserMapper.xml 更新
- 更新了结果映射以匹配新的表结构
- 更新了所有 SQL 语句
- 移除了逻辑删除相关的条件

### 4. UserService 接口更新
- `getUserById` 参数类型改为 `String`
- 添加了 `getUserByUsername` 方法
- 添加了 `updateUser` 方法

### 5. UserServiceImpl 更新
- 在 `createUser` 方法中自动生成 UUID
- 移除了逻辑删除相关逻辑
- 添加了 `updateUser` 方法实现

### 6. AuraLinkPointsServiceImpl 更新
- 更新了积分查询逻辑，使用 `user.getId()` 而不是 `user.getUserId()`

## 新增功能

### UserController
创建了完整的用户管理控制器，提供以下 API：

- `GET /api/users/{id}` - 根据用户ID查询用户信息
- `GET /api/users/wallet/{walletAddress}` - 根据钱包地址查询用户信息
- `GET /api/users/username/{username}` - 根据用户名查询用户信息
- `POST /api/users` - 创建用户
- `PUT /api/users/{id}` - 更新用户信息
- `GET /api/users/health` - 健康检查

## 使用示例

### 创建用户
```json
POST /api/users
{
  "walletAddress": "0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6",
  "username": "testuser",
  "avatar": "https://example.com/avatar/123.png"
}
```

### 查询用户
```bash
# 根据用户ID查询
GET /api/users/550e8400-e29b-41d4-a716-446655440000

# 根据钱包地址查询
GET /api/users/wallet/0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6

# 根据用户名查询
GET /api/users/username/testuser
```

### 更新用户
```json
PUT /api/users/550e8400-e29b-41d4-a716-446655440000
{
  "username": "newusername",
  "avatar": "https://example.com/avatar/456.png"
}
```

## 积分系统集成

现在 `AuraLinkPointsService` 的 `mintPoints` 方法可以正确工作：

1. 根据钱包地址查询用户信息
2. 使用用户的 UUID (`user.getId()`) 查询睡眠积分
3. 验证铸造数量并执行代币铸造

## 注意事项

1. **UUID 生成**：创建用户时会自动生成 UUID 作为用户ID
2. **钱包地址唯一性**：钱包地址必须唯一
3. **用户名唯一性**：用户名必须唯一（如果提供）
4. **物理删除**：用户删除是物理删除，不是逻辑删除
5. **时间戳**：创建和更新时间会自动设置

## 数据库迁移

如果你需要从旧的表结构迁移到新的表结构，建议：

1. 备份现有数据
2. 创建新的 users 表
3. 迁移数据（需要将旧的 user_id 映射到新的 UUID）
4. 更新 sleep_points 表中的 user_id 字段以匹配新的 UUID

所有代码已经更新完成，现在应该可以正常编译和运行了。
